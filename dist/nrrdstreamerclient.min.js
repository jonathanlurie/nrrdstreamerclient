!function(r,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):r.nrrdstreamerclient=t()}(this,function(){"use strict";var r=1e-6,t="undefined"!=typeof Float32Array?Float32Array:Array;Math.PI;function n(){var r=new t(3);return t!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r}function e(r,n,e){var i=new t(3);return i[0]=r,i[1]=n,i[2]=e,i}function i(r,t,n){var e=t[0],i=t[1],a=t[2],s=n[0],o=n[1],d=n[2];return r[0]=i*d-a*o,r[1]=a*s-e*d,r[2]=e*o-i*s,r}var a,s=function(r){var t=r[0],n=r[1],e=r[2];return Math.sqrt(t*t+n*n+e*e)};a=n();!function(){var r,n=(r=new t(4),t!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0,r[3]=0),r)}();function o(){var r=new t(4);return t!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r[3]=1,r}function d(t,n,e,i){var a,s,o,d,l,u=n[0],h=n[1],y=n[2],g=n[3],c=e[0],f=e[1],A=e[2],p=e[3];return(s=u*c+h*f+y*A+g*p)<0&&(s=-s,c=-c,f=-f,A=-A,p=-p),1-s>r?(a=Math.acos(s),o=Math.sin(a),d=Math.sin((1-i)*a)/o,l=Math.sin(i*a)/o):(d=1-i,l=i),t[0]=d*u+l*c,t[1]=d*h+l*f,t[2]=d*y+l*A,t[3]=d*g+l*p,t}var l,u,h,y,g,c,f,A=function(r,t){var n=t[0],e=t[1],i=t[2],a=t[3],s=n*n+e*e+i*i+a*a;return s>0&&(s=1/Math.sqrt(s)),r[0]=n*s,r[1]=e*s,r[2]=i*s,r[3]=a*s,r};l=n(),u=e(1,0,0),h=e(0,1,0),y=o(),g=o(),c=new t(9),t!=Float32Array&&(c[1]=0,c[2]=0,c[3]=0,c[5]=0,c[6]=0,c[7]=0),c[0]=1,c[4]=1,c[8]=1,f=c;!function(){var r,n=(r=new t(2),t!=Float32Array&&(r[0]=0,r[1]=0),r)}();const p={"signed char":Int8Array,int8:Int8Array,int8_t:Int8Array,uchar:Uint8Array,"unsigned char":Uint8Array,uint8:Uint8Array,uint8_t:Uint8Array,short:Int16Array,"short int":Int16Array,"signed short":Int16Array,"signed short int":Int16Array,int16:Int16Array,int16_t:Int16Array,ushort:Uint16Array,"unsigned short":Uint16Array,"unsigned short int":Uint16Array,uint16:Uint16Array,uint16_t:Uint16Array,int:Int32Array,"signed int":Int32Array,int32:Int32Array,int32_t:Int32Array,uint:Uint32Array,"unsigned int":Uint32Array,uint32:Uint32Array,uint32_t:Uint32Array,longlong:BigInt64Array,"long long":BigInt64Array,"long long int":BigInt64Array,"signed long long":BigInt64Array,"signed long long int":BigInt64Array,int64:BigInt64Array,int64_t:BigInt64Array,ulonglong:BigUint64Array,"unsigned long long":BigUint64Array,"unsigned long long int":BigUint64Array,uint64:BigUint64Array,uint64_t:BigUint64Array,float:Float32Array,double:Float64Array},_=600,m="\n";return class{constructor(r,t={}){this._url=r,this._httpHeaders=t,this._nrrdHeader=null,this._dataByteOffset=null,this._nrrdVersion=null}setHttpHeader(r){this._httpHeaders=r}getNrrdHeader(r){let t=this,n=JSON.parse(JSON.stringify(this._httpHeaders));n.range=`bytes=0-${_}`,fetch(this._url,{headers:n}).then(function(r){return r.text()}).then(function(n){t._findDataOffset(n),t._parseNrrdHeader(n,r)})}_findDataOffset(r){for(let t=1;t<r.length;t++)if(r[t]===m&&r[t-1]===m){this._dataByteOffset=t+1;break}}_parseNrrdHeader(r,t){let n=r.slice(0,this._dataByteOffset).trim().split(m),e=(n[0].trim(),n.slice(1).filter(r=>r.length>0).filter(r=>"#"!==r[0]).map(r=>{let t=r.split(":");return{key:t[0].trim(),val:t[1].trim()}})),i={};e.forEach(r=>{i[r.key]=r.val}),i.sizes&&(i.sizes=i.sizes.split(" ").map(r=>parseInt(r))),i["space directions"]&&(i["space directions"]=i["space directions"].split(" ").map(r=>r.slice(1,r.length-1).split(",").map(r=>parseFloat(r)))),i.dimension&&(i.dimension=parseInt(i.dimension)),i["space origin"]&&(i["space origin"]=i["space origin"].slice(1,i["space origin"].length-1).split(",").map(r=>parseFloat(r))),i.kinds&&(i.kinds=i.kinds.split(" ")),i["space dimension"]&&(i["space dimension"]=parseInt(i["space dimension"])),this._nrrdHeader=i,t(i)}streamNrrdValue(r,t){let n=this;this._nrrdHeader?this._streamValue(r,t):this.getNrrdHeader(function(e){n._streamValue(r,t)})}_streamValue(r,t){let n={error:null,position:r,value:null};if("raw"!==this._nrrdHeader.encoding)return n.error=new Error(`To stream content, the encoding of the NRRD file must be 'raw' (aka. uncompressed). Found: '${this._nrrdHeader.encoding}'`),t(n);let e=this._nrrdHeader.sizes[0],i=this._nrrdHeader.sizes[1],a=(this._nrrdHeader.sizes[2],p[this._nrrdHeader.type]),s=a.BYTES_PER_ELEMENT,o=this._getPositionWorldToVoxel(r),d=(e*i*o[2]+e*o[1]+o[0])*s+this._dataByteOffset;if(o[0]<0||o[0]>this._nrrdHeader.sizes[0]||o[1]<0||o[1]>this._nrrdHeader.sizes[1]||o[2]<0||o[2]>this._nrrdHeader.sizes[2])return n.error=new Error("The position is outside the volume."),t(n);let l=JSON.parse(JSON.stringify(this._httpHeaders));l.range=`bytes=${d}-${d+s-1}`,fetch(this._url,{headers:l}).then(function(r){return r.blob()}).then(function(r){let e=new FileReader;e.onload=function(r){let e=r.target.result;n.value=new a(e)[0],t(n)},e.readAsArrayBuffer(r)})}_getPositionWorldToVoxel(r){let i=this._nrrdHeader["space origin"],a=this._nrrdHeader["space directions"],s=(o=a[0][0],d=a[0][1],l=a[0][2],u=0,h=a[1][0],y=a[1][1],g=a[1][2],c=0,f=a[2][0],A=a[2][1],p=a[2][2],_=0,m=i[0],H=i[1],I=i[2],v=1,(B=new t(16))[0]=o,B[1]=d,B[2]=l,B[3]=u,B[4]=h,B[5]=y,B[6]=g,B[7]=c,B[8]=f,B[9]=A,B[10]=p,B[11]=_,B[12]=m,B[13]=H,B[14]=I,B[15]=v,B);var o,d,l,u,h,y,g,c,f,A,p,_,m,H,I,v,B;let U=function(){var r=new t(16);return t!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=0,r[12]=0,r[13]=0,r[14]=0),r[0]=1,r[5]=1,r[10]=1,r[15]=1,r}();!function(r,t){var n=t[0],e=t[1],i=t[2],a=t[3],s=t[4],o=t[5],d=t[6],l=t[7],u=t[8],h=t[9],y=t[10],g=t[11],c=t[12],f=t[13],A=t[14],p=t[15],_=n*o-e*s,m=n*d-i*s,H=n*l-a*s,I=e*d-i*o,v=e*l-a*o,B=i*l-a*d,U=u*f-h*c,w=u*A-y*c,F=u*p-g*c,N=h*A-y*f,O=h*p-g*f,z=y*p-g*A,M=_*z-m*O+H*N+I*F-v*w+B*U;M&&(M=1/M,r[0]=(o*z-d*O+l*N)*M,r[1]=(i*O-e*z-a*N)*M,r[2]=(f*B-A*v+p*I)*M,r[3]=(y*v-h*B-g*I)*M,r[4]=(d*F-s*z-l*w)*M,r[5]=(n*z-i*F+a*w)*M,r[6]=(A*H-c*B-p*m)*M,r[7]=(u*B-y*H+g*m)*M,r[8]=(s*O-o*F+l*U)*M,r[9]=(e*F-n*O-a*U)*M,r[10]=(c*v-f*H+p*_)*M,r[11]=(h*H-u*v-g*_)*M,r[12]=(o*w-s*N-d*U)*M,r[13]=(n*N-e*w+i*U)*M,r[14]=(f*m-c*I-A*_)*M,r[15]=(u*I-h*m+y*_)*M)}(U,s);let w=e(r[0],r[1],r[2]),F=n();return function(r,t,n){var e=t[0],i=t[1],a=t[2],s=n[3]*e+n[7]*i+n[11]*a+n[15];s=s||1,r[0]=(n[0]*e+n[4]*i+n[8]*a+n[12])/s,r[1]=(n[1]*e+n[5]*i+n[9]*a+n[13])/s,r[2]=(n[2]*e+n[6]*i+n[10]*a+n[14])/s}(F,w,U),F.map(r=>Math.round(r))}}});
